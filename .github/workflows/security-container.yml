name: Security - Container Scanning

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:

jobs:
  container-scan:
    name: Container and Filesystem Vulnerability Scanning
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: agramkow-api
        run: |
          docker build -t agramkow-api:${{ github.sha }} .
          docker tag agramkow-api:${{ github.sha }} agramkow-api:latest

      - name: Run Trivy vulnerability scanner on image
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: 'agramkow-api:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container-scan'

      - name: Run Trivy for JSON report
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: 'agramkow-api:${{ github.sha }}'
          format: 'json'
          output: 'trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: './agramkow-api'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy filesystem results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-fs-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: 'trivy-filesystem-scan'

      - name: Security Gate - Phased Enforcement
        if: always()
        run: |
          echo "Security Gate Evaluation"
          echo ""

          if [ ! -f trivy-report.json ]; then
            echo "No Trivy report found - skipping security gate"
            exit 0
          fi

          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json 2>/dev/null || echo "0")
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json 2>/dev/null || echo "0")
          MEDIUM_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report.json 2>/dev/null || echo "0")

          echo "Trivy Container Scan Results:"
          echo "  Critical: $CRITICAL_COUNT"
          echo "  High: $HIGH_COUNT"
          echo "  Medium: $MEDIUM_COUNT"
          echo ""

          BRANCH_NAME="${GITHUB_REF##*/}"

          if [ "$BRANCH_NAME" = "main" ]; then
            ENVIRONMENT="production"
          elif [[ "$BRANCH_NAME" == release/* ]]; then
            ENVIRONMENT="staging"
          else
            ENVIRONMENT="development"
          fi

          echo "Environment: $ENVIRONMENT"
          echo ""

          if [ "$ENVIRONMENT" = "development" ]; then
            echo "Monitoring mode enabled"
            echo "All vulnerabilities logged"
            echo "No blocking enforced"
          fi

          if [ "$ENVIRONMENT" = "staging" ]; then
            if [ "$CRITICAL_COUNT" -gt "0" ]; then
              echo "Blocking deployment due to CRITICAL vulnerabilities"
              exit 1
            fi
            echo "HIGH vulnerabilities logged as warnings"
          fi

          if [ "$ENVIRONMENT" = "production" ]; then
            if [ "$CRITICAL_COUNT" -gt "0" ] || [ "$HIGH_COUNT" -gt "0" ]; then
              echo "Blocking deployment due to CRITICAL or HIGH vulnerabilities"
              exit 1
            fi
            if [ "$MEDIUM_COUNT" -gt "0" ]; then
              echo "MEDIUM vulnerabilities detected - review recommended"
            fi
          fi

          echo ""
          echo "Security gate evaluation completed"

      - name: Generate Security Summary
        if: always()
        run: |
          echo "## Container Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f trivy-report.json ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-report.json 2>/dev/null || echo "0")

            echo "**Container Vulnerabilities (Trivy):**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**View Detailed Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Navigate to the Security tab to view all findings" >> $GITHUB_STEP_SUMMARY
          echo "- Download security reports from Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "- Review Code scanning alerts for vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY

      - name: Collect security artifacts
        if: always()
        run: |
          mkdir -p security-reports
          [ -f trivy-report.json ] && cp trivy-report.json security-reports/ || true
          [ -f trivy-results.sarif ] && cp trivy-results.sarif security-reports/ || true
          [ -f trivy-fs-results.sarif ] && cp trivy-fs-results.sarif security-reports/ || true
          ls -la security-reports/ || echo "No security reports generated"

      - name: Upload all security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-reports-${{ github.sha }}
          path: security-reports/
          retention-days: 90
          if-no-files-found: warn