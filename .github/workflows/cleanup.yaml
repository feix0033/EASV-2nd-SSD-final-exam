name: Cleanup Old Artifacts

on:
  schedule:
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup Old Artifacts and Caches
    runs-on: ubuntu-latest

    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30);
            
            let deletedCount = 0;
            
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              
              if (createdAt < cutoffDate) {
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });
                console.log(`Deleted artifact: ${artifact.name} (${artifact.id})`);
                deletedCount++;
              }
            }
            
            console.log(`Deleted ${deletedCount} old artifacts`);
            core.setOutput('deleted_count', deletedCount);

      - name: Delete old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 90);
            
            let deletedCount = 0;
            
            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100,
                status: 'completed'
              });
              
              for (const run of runs.data.workflow_runs) {
                const createdAt = new Date(run.created_at);
                
                if (createdAt < cutoffDate && run.conclusion !== 'success') {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner,
                      repo,
                      run_id: run.id
                    });
                    console.log(`Deleted workflow run: ${run.name} (${run.id})`);
                    deletedCount++;
                  } catch (error) {
                    console.log(`Could not delete run ${run.id}: ${error.message}`);
                  }
                }
              }
            }
            
            console.log(`Deleted ${deletedCount} old workflow runs`);
            core.setOutput('deleted_runs_count', deletedCount);

      - name: Clear old caches
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            const caches = await github.rest.actions.getActionsCacheList({
              owner,
              repo,
              per_page: 100
            });
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);
            
            let deletedCount = 0;
            
            for (const cache of caches.data.actions_caches) {
              const createdAt = new Date(cache.created_at);
              const lastAccessedAt = new Date(cache.last_accessed_at);
              
              if (lastAccessedAt < cutoffDate) {
                try {
                  await github.rest.actions.deleteActionsCacheById({
                    owner,
                    repo,
                    cache_id: cache.id
                  });
                  console.log(`Deleted cache: ${cache.key} (${cache.id})`);
                  deletedCount++;
                } catch (error) {
                  console.log(`Could not delete cache ${cache.id}: ${error.message}`);
                }
              }
            }
            
            console.log(`Deleted ${deletedCount} old caches`);
            core.setOutput('deleted_caches_count', deletedCount);

      - name: Generate cleanup summary
        if: always()
        run: |
          echo "## Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cleanup completed successfully.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Old artifacts, workflow runs, and caches have been removed to optimize storage." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Retention Policies:**" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts: 30 days" >> $GITHUB_STEP_SUMMARY
          echo "- Failed workflow runs: 90 days" >> $GITHUB_STEP_SUMMARY
          echo "- Unused caches: 7 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Commit: ${{ github.sha }}*" >> $GITHUB_STEP_SUMMARY